<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:context="http://www.springframework.org/schema/context"
    xsi:schemaLocation="
    http://www.springframework.org/schema/beans 
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://camel.apache.org/schema/spring 
    http://camel.apache.org/schema/spring/camel-spring.xsd
    http://www.springframework.org/schema/context 
    http://www.springframework.org/schema/context/spring-context-3.0.xsd" 
    >
    
    <!-- AWS Configuration -->
    <context:property-placeholder  location="classpath:/aws.properties" />
    <bean name="sqsClient" class="com.amazonaws.services.sqs.AmazonSQSAsyncClient">
        <constructor-arg>
            <bean class="com.amazonaws.auth.BasicAWSCredentials">
                <constructor-arg value="${access.key}"/>
                <constructor-arg value="${secret.key}"/>
            </bean>
        </constructor-arg>
    </bean>

    <!-- Set a shorter timeout for shutdown, primarily for testing purposes. Default is 300. -->
    <bean id="shutdown" class="org.apache.camel.impl.DefaultShutdownStrategy">  
        <property name="timeout" value="30"/>
    </bean>  

    <!-- Configure display of trace log messages -->
    <bean id="traceFormatter" class="org.apache.camel.processor.interceptor.DefaultTraceFormatter">
        <property name="showBody" value="false"/>
        <property name="showHeaders" value="false"/>
    </bean>

    <!-- Definition of beans that handle processing of items in the pipeline -->
	<bean id="marcSplitter" class="edu.harvard.libcomm.pipeline.MarcSplitter"/>		
    <bean id="modsProcessor" class="edu.harvard.libcomm.pipeline.LibCommProcessor">
        <property name="processor">
            <bean class="edu.harvard.libcomm.pipeline.ModsProcessor"/>
        </property>
    </bean>
    <bean id="holdingsProcessor" class="edu.harvard.libcomm.pipeline.LibCommProcessor">
        <property name="processor">
            <bean class="edu.harvard.libcomm.pipeline.HoldingsProcessor"/>
        </property>
    </bean>


    <camelContext id="sqsContext" xmlns="http://camel.apache.org/schema/spring" trace="true">
        <!-- Environment-specific properties -->
        <propertyPlaceholder id="librarycloud-properties" location="classpath:/librarycloud.env.properties" />

        <!-- Error handling behavior -->
        <errorHandler id="eh" redeliveryPolicyRef="myPolicy" type="DeadLetterChannel" 
            deadLetterUri="aws-sqs://{{librarycloud.sqs.environment}}-dead-letter?accessKey=${access.key}&amp;secretKey=${secret.key}&amp;amazonSQSClient=#sqsClient"/>
        <redeliveryPolicyProfile id="myPolicy" maximumRedeliveries="3"/>

 		<!-- 
 		aleph-ingest route reads xml messages from directory that contain corresponding marc (.mrc) files
 		converts marc communication format to marcxml, chunks into files of 25 and writes to specified directory
 		xml messages sent to queue
 		 -->
        <route id="aleph-ingest-split" errorHandlerRef="eh">
            <from uri="file:{{librarycloud.files.basepath}}/ingest-aleph?include=.*.xml" />
            <!-- <from uri="aws-sqs://{{librarycloud.sqs.environment}}-ingest-aleph?accessKey=${access.key}&amp;secretKey=${secret.key}&amp;amazonSQSClient=#sqsClient" /> -->

            <!-- Try block required for errors thrown out of the splitter -->
            <doTry>
                <split streaming="true" parallelProcessing="true">
                    <method bean="marcSplitter" method="splitMarcFile"/>
                    <!-- <to uri="file:{{librarycloud.files.basepath}}/normalize-marcxml?fileName=${header.CamelSplitIndex}"/> -->
                    <to uri="aws-sqs://{{librarycloud.sqs.environment}}-normalize-marcxml?accessKey=${access.key}&amp;secretKey=${secret.key}&amp;amazonSQSClient=#sqsClient" />
                </split>
                <doCatch>
                    <exception>java.lang.Exception</exception>
                    <to uri="aws-sqs://{{librarycloud.sqs.environment}}-dead-letter?accessKey=${access.key}&amp;secretKey=${secret.key}&amp;amazonSQSClient=#sqsClient" />
                </doCatch>
            </doTry>

         </route>

  		<!-- 
 		marctomods route reads marcxml from specified dir, validates, converts marcxml to mods
 		mods wrapped in libcomm message and sent to queue (can be file, aws, etc)
 		 -->         
   
         <route id="marctomods"  errorHandlerRef="eh">
            <!-- <from uri="file:{{librarycloud.files.basepath}}/normalize-marcxml" /> -->
            <from uri="aws-sqs://{{librarycloud.sqs.environment}}-normalize-marcxml?accessKey=${access.key}&amp;secretKey=${secret.key}&amp;amazonSQSClient=#sqsClient" />
            <process ref="modsProcessor"/>
            <!-- <to uri="file:{{librarycloud.files.basepath}}/enrich"/> -->
            <to uri="aws-sqs://{{librarycloud.sqs.environment}}-enrich?accessKey=${access.key}&amp;secretKey=${secret.key}&amp;amazonSQSClient=#sqsClient" />
        </route>

<!--        <route id="addholdingstomods">
            <from uri="file:/temp/aleph/mods" />
            <process ref="holdingsProcessor"/>
            <to uri="file:/temp/aleph/enhancedmods"/>
            <to uri="aws-sqs://viaIngest?accessKey=${access.key}&amp;secretKey=${secret.key}&amp;amazonSQSClient=#sqsClient" />
 			<log message="holdings added ${file:name}"/>
        </route>
 -->        
<!-- 
        <route id="modstosolr">
            <from uri="aws-sqs://modsQueue?accessKey=${access.key}&amp;secretKey=${secret.key}&amp;amazonSQSClient=#sqsClient" />
            <to uri="aws-sqs://solrQueue?accessKey=${access.key}&amp;secretKey=${secret.key}&amp;amazonSQSClient=#sqsClient" />
 			<log message="to mods do solr ${file:name}"/>
        </route>        
-->              
    </camelContext>
    
    
</beans>
